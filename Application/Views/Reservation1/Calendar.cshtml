@{
    var services = (IEnumerable<Data.Entities.Service>)ViewData["services"];
    var availableSlots = (IEnumerable<Data.Entities.ReservationSlots>)ViewData["availableSlots"];
    var busySlots = (IEnumerable<Data.Entities.ReservationSlots>)ViewData["busySlots"];
    var settings = new Newtonsoft.Json.JsonSerializerSettings { ReferenceLoopHandling = Newtonsoft.Json.ReferenceLoopHandling.Ignore };
    var userReservations = (IEnumerable<Data.Entities.Reservation1>)ViewData["userReservations"];
    var userReservationsJson = Newtonsoft.Json.JsonConvert.SerializeObject(userReservations, settings);
}

<head>
    <script src="~/assets/vendors/js/vendor.bundle.base.js"></script>
    <script src="~/assets/js/off-canvas.js"></script>
    <script src="~/assets/js/hoverable-collapse.js"></script>
    <script src="~/assets/js/misc.js"></script>
</head>


<style>
    .button-disabled {
        opacity: 0.5; 
    }

    .buttons-container {
        display: flex;
        justify-content: center;
    }

    .buttons-container2 {
        display: flex;
        justify-content: center;
        flex-direction: column;
        align-items: center;
    }
    #calendar {
        max-width: 1100px;
        margin: 0 auto;
        background-color: white; /* Białe tło kalendarza */
    }

    a.fc-day-header {
        background-color: mediumpurple;
        color: black;
        text-decoration: none; /* Usunięcie podkreślenia */
    }

    a.fc-scroll-grid-sync-inner {
        background-color: magenta; /* Kolor tła */
    }

    a {
        color: black;
        text-decoration: none; /* Usunięcie podkreślenia */
    }

    button {
        border-radius: 5px; /* Zaokrąglenie krawędzi */
        padding: 5px 10px; /* Wewnętrzny padding */
        background-color: magenta; /* Kolor tła */
        color: white; /* Kolor tekstu */
        border: none; /* Usunięcie obramowania */
        margin: 5px; /* Margines */
    }
</style>


@if (TempData["ErrorMessage"] != null)
{
    <script>
        alert("@TempData["ErrorMessage"]");
    </script>
}

<div class="buttons-container">
    @foreach (var service in services)
    {
        <button id="@("btn_" + service.Id)" onclick="showSlots('@service.Id')">@(service.Name)</button>
    }
</div>
<div class="buttons-container2" id="slots-container"></div>
<div id='calendar'></div>

<div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
            </div>
            <div class="modal-body" id="modalContent">
            </div>
        </div>
    </div>
</div>


<script>
    var selectedDate; // Zmienna przechowująca wybraną datę
    function showSlots(serviceId) {
        // Przekazanie wybranej daty do funkcji zwracającej sloty
        $.ajax({
            url: '/Reservation1/GetSlots',
            method: 'GET',
            dataType: 'json',
            data: {
                serviceId: serviceId,
                selectedDate: selectedDate
            },
            success: function (response) {
                var objAsString = JSON.stringify(response);
                var parsedObject = JSON.parse(objAsString);

                var availableSlots = parsedObject.AvailableSlots || parsedObject.availableSlots;
                var busySlots = parsedObject.BusySlots || parsedObject.busySlots;

                console.log('Dostępne sloty:', availableSlots);
                console.log('Zajęte sloty:', busySlots);

                var slotsContainer = document.getElementById('slots-container');
                slotsContainer.innerHTML = '';

                for (var i = 0; i < availableSlots.length; i++) {
                    var slot = availableSlots[i];
                    console.log('slot:', slot);
                    var btn = document.createElement('button');
                    btn.textContent = slot.startTime + ' - ' + slot.endTime;
                    btn.onclick = function () {
                        $.ajax({
                            url: '/Reservation1/NewReservation',
                            method: 'GET',
                            data: {
                                serviceId: serviceId, 
                                selectedDate: selectedDate,
                                reservationSlotsId: slot.id // Zastąp zgodnie z modelem danych
                            },
                            success: function (response) {
                                $('#modalContent').html(response); // Wyświetlenie treści z partial view w modalu
                                $('#myModal').modal('show'); // Wyświetlenie modalu
                            },
                            error: function (xhr, status, error) {
                                console.error('Wystąpił błąd podczas wywoływania akcji NewReservation:', error);
                            }
                        });
                    };
                    slotsContainer.appendChild(btn);
                }

                for (var j = 0; j < busySlots.length; j++) {
                    var busySlot = busySlots[j];
                    console.log('slot:', busySlot);
                    var btnBusy = document.createElement('button');
                    btnBusy.textContent = busySlot.startTime + ' - ' + busySlot.endTime + ' (Busy)';
                    btnBusy.classList.add('button-disabled');
                    btnBusy.onclick = function () {
                       var confirmed = confirm('Czy chcesz być powiadomiony, gdy ten termin stanie się dostępny?');
                            if (confirmed) {
                                $.ajax({
                                    url: '/Reservation1/SubscribeSlot',
                                    method: 'POST',
                                    data: {
                                        reservationSlotId: busySlot.id
                                    },
                                    success: function (response) {
                                    },
                                    error: function (xhr, status, error) {
                                        console.error('Wystąpił błąd podczas subskrybowania na niedostępny termin:', error);
                                    }
                                });
                            }
                    };
                    slotsContainer.appendChild(btnBusy);
                }
            },
            error: function (xhr, status, error) {
                console.error('Wystąpił błąd podczas pobierania danych:', error);
            }

        });
          
    }

    document.addEventListener('DOMContentLoaded', function () {
        var userReservations = @Html.Raw(userReservationsJson);
        var events = [];

        for (let reservation of userReservations) {
            var startDateTime = new Date(`${reservation.ReservationSlot.Date.slice(0, 10)}T${reservation.ReservationSlot.StartTime}`);
            var endDateTime = new Date(`${reservation.ReservationSlot.Date.slice(0, 10)}T${reservation.ReservationSlot.EndTime}`);
            console.log("start time: " + startDateTime)
            console.log("end time: " + endDateTime)
            events.push({
                id: reservation.Id,
                start: startDateTime,
                end: endDateTime,
                title: `${reservation.ReservationSlot.StartTime} - ${reservation.ReservationSlot.EndTime}`
            });
        }
        console.log("events: " + events)

        var calendarEl = document.getElementById('calendar');

        var calendar = new FullCalendar.Calendar(calendarEl, {
            headerToolbar: {
                left: 'prevYear,prev,next,nextYear today',
                center: 'title',
                right: 'dayGridMonth,dayGridWeek'
            },
            initialDate: '2023-12-12',
            navLinks: true, // can click day/week names to navigate views
            dayMaxEvents: true, // allow "more" link when too many events
            events: events,
            dateClick: function (info) {
                selectedDate = info.dateStr; 
            },
            eventClick: function (info) {
                var clickedEvent = info.event;
                var reservationId = clickedEvent.id; 

                $.ajax({
                    url: '/Reservation1/GetReservationDetails',
                    method: 'GET',
                    data: {
                        reservationId: reservationId
                    },
                    success: function (response) {
                        $('#modalContent').html(response); 
                        $('#myModal').modal('show'); 
                    },
                    error: function (xhr, status, error) {
                        console.error('Wystąpił błąd podczas pobierania szczegółów rezerwacji:', error);
                    }
                });
            }

        });

        calendar.render();
    });
</script>
