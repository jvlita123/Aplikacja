@model IEnumerable<Data.Entities.Reservation1>
@using Data.Entities;
@{
    IEnumerable<Status> statuses = (IEnumerable<Data.Entities.Status>)ViewData["statuses"];
}
<head>
    <link rel="stylesheet" href="~/assets/css/style.css" />
    <script src="../../assets/vendors/js/vendor.bundle.base.js"></script>
    <script src="../../assets/js/off-canvas.js"></script>
    <script src="../../assets/js/hoverable-collapse.js"></script>
    <script src="../../assets/js/misc.js"></script>
    <script src="~/assets/vendors/js/vendor.bundle.base.js"></script>
    <script src="~/assets/vendors/chart.js/Chart.min.js"></script>
    <script src="~/assets/js/off-canvas.js"></script>
    <script src="~/assets/js/hoverable-collapse.js"></script>
    <script src="~/assets/js/misc.js"></script>
    <script src="~/assets/js/chart.js"></script>
</head>

<div class="row">
    <div class="col-12 grid-margin">
        <div class="card">
            <div class="card-body">
                <h4 class="card-title">Reservations</h4>
                <div class="input-group">
                    <input type="text" class="form-control" id="userSearch" placeholder="Search user">
                    <span class="input-group-text"><i class="mdi mdi-account-search-outline"></i></span>
                </div>
                <div class="table-responsive">
                    <table class="table">
                        <thead>
                            <tr>
                                <th> User </th>
                                <th> Service </th>
                                <th class="" style="text-decoration:none; font-weight:normal">
                                    <a class="nav-link dropdown-toggle" id="profileDropdown" href="#" data-bs-toggle="dropdown" aria-expanded="false">
                                        Status
                                    </a>
                                    <div class="dropdown-menu navbar-dropdown" aria-labelledby="profileDropdown">
                                        @foreach (var v in statuses)
                                        {
                                            <a class="dropdown-item selected-status">
                                                @v.Name
                                            </a>
                                            <div class="dropdown-divider"></div>
                                        }
                                        <a class="dropdown-item selected-status">
                                            All
                                        </a>
                                    </div>
                                </th>
                                <th> Start </th>
                                <th> End </th>
                                <th>       </th>
                            </tr>
                        </thead>
                        <tbody id="reservationsTable">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="deleteConfirmationModal">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Are you sure you want to delete this reservation?</h5>
                <button type="button" class="close" data-dismiss="modal">&times;</button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this reservation?</p>
            </div>
            <div class="modal-footer">
                <button id="confirmDeleteBtn" class="btn btn-danger" data-dismiss="modal">Yes</button>
                <button id="cancelDeleteBtn" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
            </div>
        </div>
    </div>
</div>

<div id="editModal" class="modal fade" role="dialog">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal">&times;</button>
            </div>
            <div class="modal-body" id="editReservationContent">
            </div>
        </div>
    </div>
</div>


<div class="modal fade" tabindex="-1" role="dialog" id="myModal1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Change Reservation Status</h5>
                <span aria-hidden="true">
                    <button type="button" class="btn-close" data-dismiss="modal" aria-label="Close">
                    </button>
                </span>
            </div>
            <div class="modal-body " id="contentReservation">
            </div>
        </div>
    </div>
</div>

<div class="alert alert-success alert-dismissible fade" id="statusChangedMsg" role="alert" style="display: none;">
    Status has been changed.
    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<link href="~/lib/bootstrap/dist/css/bootstrap.min.css">

    <script>

    const deleteReservationBtn = $('#deleteReservationBtn');
    console.log(deleteReservationBtn);


    $('#deleteReservationBtn').on('click', function () {
        $('#deleteConfirmationModal').modal('show');
    });

    $('#editReservationBtn').on('click', function () {
        var reservationId = 60; // Assuming the ID can be retrieved in this context
        $('#editModal').modal('show');
        $.ajax({
            url: '/Reservation/EditReservation', // Check if this URL is correct
            type: 'GET',
            data: { id: reservationId }, // Pass the reservation ID
            success: function (data) {
                $('#editReservationContent').html(data);
            }
        });
    });

    $('#confirmDeleteBtn').on('click', function () {
        var reservationId = 60; // Pobierz identyfikator rezerwacji z modelu
        $.ajax({
            url: '/Reservation/RemoveReservation', // Sprawdź poprawność ścieżki do akcji kontrolera
            type: 'POST',
            data: { id: reservationId }, // Przekazanie identyfikatora rezerwacji
            success: function (data) {
                // Tutaj możesz obsłużyć odpowiedź zwrotną po usunięciu rezerwacji
                // Na przykład, odśwież stronę lub wykonaj dodatkowe działania
                window.location.href = '/Reservation/Calendar'; // Modify the URL accordingly
            }
        });
    });

        var selectedStatus = 'All';
        refreshTable(selectedStatus);

        $(document).on('click', '.changeReservationStatus', function () {
            var reservationId = $(this).data('reservation-id');
            var statusChangedMsg = $('#statusChangedMsg');

        $("#myModal1").modal("show");
            $.ajax({
                url: '/Reservation1/changeReservationStatus',
                type: 'GET',
                data: { id: reservationId },
                success: function (data) {
                    $('#contentReservation').html(data);
                    statusChangedMsg.fadeIn().delay(3000).fadeOut();

                    $('#myModal1 .form').on('submit', function (event) {
                    event.preventDefault(); // Zapobieganie domyślnej akcji formularza

                    // Pobieranie danych z formularza
                    var formData = $(this).serialize();

                    $.ajax({
                        url: '/Reservation1/changeReservationStatus',
                        type: 'POST',
                        data: formData,
                        success: function (data) {
                            // Po zmianie statusu, odświeżanie tabeli
                            refreshTable(selectedStatus);
                        }
                    });
                    });
                }
            });
        });

    $(document).on('click', '.selected-status', function () {
        selectedStatus = $(this).text().trim(); // Usunięcie 'var' przed 'selectedStatus'
        refreshTable(selectedStatus);
    });

        function refreshTable(selectedStatus) {
            $.ajax({
                url: '/Reservation1/getReservationsByStatus',
                type: 'GET',
                data: { status: selectedStatus },
                success: function (result) {
                    $('#reservationsTable').html(result);
                },
            });
        }

        function allReservations() {
            $.ajax({
                url: '/Reservation1/getAll',
                type: 'GET',
                data: { status: selectedStatus },
                success: function (result) {
                    $('#reservationsTable').html(result);
                },
            });
        }

    $('#userSearch').on('keyup', function () {
        var searchText = $(this).val().toLowerCase(); // Pobierz wartość wprowadzoną do pola tekstowego i zmień na małe litery
        filterTable(searchText); // Wywołaj funkcję do filtrowania tabeli
    });

    function filterTable(searchText) {
        $('#reservationsTable tr').each(function () { // Pomijanie pierwszego wiersza (nagłówka)
            var username = $(this).find('td:first').text().toLowerCase(); // Pobieranie nazwy użytkownika z pierwszej komórki

            // Sprawdzenie, czy nazwa użytkownika pasuje do wprowadzonego tekstu
            if (username.indexOf(searchText) === -1) {
                $(this).hide(); // Jeśli nie pasuje, ukryj wiersz
            } else {
                $(this).show(); // Jeśli pasuje, pokaż wiersz
            }
        });
    }
    </script>


